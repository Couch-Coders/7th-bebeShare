<!doctype html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout}">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">


    <th:block layout:fragment="css">
        <style th:inline="css">
            .center-img {
                height: 300px;
                width: 100%;
            }

            .card-text {
                height: 300px;
            }
        </style>
    </th:block>

    <title>배배쉐어</title>
    <script>

        $(function () {

            selCodes();
            selComments();

            $("input:checkbox[name=category]").click(function () { //체크박스 동작 이벤트
                    $("input:checkbox[name=category]").prop('checked',false)
                    $("input:checkbox[name=category]").removeClass('checked')
                    $(this).prop('checked',true)
                    $(this).addClass('checked')
                }
            );


            //비로그인시 댓글 입력창 상품 수정 삭제를 안보야됨
            if(!localStorage.getItem("userId")){
                $('#productStatus').hide()
                $('#commentInput').hide()
            }
            // 자기가등록한 상품이 아닐시 상품삭제  변경 버튼은 숨겨야된다
            if(localStorage.getItem("userId") !== $('#authorId').val()){
                $('#productStatus').hide()
            }
        });

        function selCodes() {

            const p_trans = {};
            let cHtml = '';
            p_trans.code = "100";

            $.ajax({
                dataType: 'json',
                type: "POST",
                contentType: "application/json;charset=utf-8",
                url: '/api/v1/categories',
                async: false,
                data: JSON.stringify(p_trans),
                success: function (data) {
                    console.log("카테고리리스트:{}", data);
                    const categories = data;

                    for (var i = 0; i < categories.length; i++) {
                        cHtml += '<div class="form-check form-check-inline">';
                        cHtml += '<input class="form-check-input" type="checkbox" id="' + categories[i].code + '" name="category">';
                        cHtml += '<label class="form-check-label" htmlFor="form-tags">' + categories[i].codeName + '</label>';
                        cHtml += '</div>';

                    }

                    $('#codes').html(cHtml);
                },
                error: function (e) {
                    console.log(e.message);
                }
            });
            //현재 상품 카테고리 체크해주기
            $('#' + $('#codes').attr('value')).prop('checked', true);
            $('#' + $('#codes').attr('value')).addClass('checked');
        }


        function updateProduct() {

            const p_trans = {};
            let cHtml = '';
            p_trans.productId = $('#productId').val();
            p_trans.productName = $('#productName').val();
            p_trans.productContent = $('#productContent').val();
            p_trans.productCategory = $('.checked').attr('id');

            $.ajax({
                dataType: 'json',
                type: "PATCH",
                contentType: "application/json;charset=utf-8",
                url: '/api/v1/products',
                async: false,
                data: JSON.stringify(p_trans),
                success: function (data) {
                    alert("상품 수정이 성공 되었습니다.");
                    location.reload();
                },
                error: function (e) {
                    console.log(e.message);
                }
            });
        }

        function deleteProduct() {

            const p_trans = {};
            let cHtml = '';
            p_trans.productId = $('#productId').val();
            p_trans.deleteYn = "Y";

            $.ajax({
                dataType: 'json',
                type: "DELETE",
                contentType: "application/json;charset=utf-8",
                url: '/api/v1/products',
                async: false,
                data: JSON.stringify(p_trans),
                success: function (data) {
                    alert("상품이 삭제 되었습니다.");
                    window.location.href = '/';
                },
                error: function (e) {
                    console.log(e.message);
                }
            });
        }





        function selComments() {

            $('#comments').empty();


            const p_trans = {};
            p_trans.productId = $('#productId').val()
            let cHtml = '';
            // p_trans.code = "100";

            $.ajax({
                dataType: 'json',
                type: "POST",
                contentType: "application/json;charset=utf-8",
                url: '/api/v1/comments',
                data: JSON.stringify(p_trans),
                success: function (data) {
                    console.log("댓글리스트:{}", data);
                    const comments = data.content;

                    for (var i = 0; i < comments.length; i++) {
                        cHtml += '<div class="card">';
                        cHtml += '<div class="card-body">';
                        cHtml += '  <div class="row">';
                        cHtml += '      <div class="col-md-2">';
                        cHtml += '          <img src="'+comments[i].picture+'" class="rounded-circle img-fluid" alt="" style="width: 118.66px;height: 118.66px;">';
                        cHtml += '      </div>';


                                  if(comments[i].userId == $('#authorId').val()){
                                      cHtml += '              <div class="col-md-10">';
                                      cHtml += '                <div class="row">';
                                      cHtml += '                    <div class="col-md-10">';
                                      cHtml += '                        <textarea class="form-control" rows="3">'+comments[i].commentContent+'</textarea>';
                                      cHtml += '                    </div>';
                                      cHtml += '                    <div class="col-md-2">';
                                      cHtml += '                        <button type="button" class="btn btn-outline-secondary" onclick="javascript:updateComment('+comments[i].commentId+')">수정</button>';
                                      cHtml += '                        <button type="button" class="btn btn-danger" onclick="javascript:deleteComment('+comments[i].commentId+')">삭제</button>';
                                      cHtml += '                        <span style="font-size: 12px;">'+comments[i].insertDt+'</span>';
                                      cHtml += '                    </div>';
                                  }else{
                                      cHtml += '              <div class="col-md-10">';
                                      cHtml += '              <div class="row">';
                                      cHtml += '              <div class="col-md-10 justify-content-center">';
                                      cHtml += '                  <p>'+comments[i].commentContent+'</p>';
                                      cHtml += '              </div>';
                                      cHtml += '              <div class="col-md-2">';
                                      cHtml += '                    <button type="button" class="btn btn-outline-secondary" style="display: none" id="'+comments[i].userId+'">수정</button>';
                                      cHtml += '                    <button type="button" class="btn btn-danger" style="display: none" id="'+comments[i].userId+'">삭제</button>';
                                      cHtml += '                    <button type="button" class="btn btn-primary p-2" id="shareBtn">나눔하기</button>';
                                      cHtml += '                    <span style="font-size: 12px;">'+comments[i].insertDt+'</span>';
                                      cHtml += '              </div>';
                                  }
                        cHtml += '              </div>';
                        cHtml += '              </div>';
                        cHtml += '              </div>';
                        cHtml += '              </div>';
                        cHtml += '              </div>';

                    }

                    $('#comments').html(cHtml);

                },
                error: function (e) {
                    console.log(e.message);
                }
            });

        }


        function updateComment(commentId,content) {

            const p_trans = {};
            let cHtml = '';
            p_trans.commentId = commentId;
            p_trans.commentContent = content;

            $.ajax({
                dataType: 'json',
                type: "PATCH",
                contentType: "application/json;charset=utf-8",
                url: '/api/v1/comments',
                async: false,
                data: JSON.stringify(p_trans),
                success: function (data) {
                    alert("댓글이 수정되었습니다.");
                    selComments();
                },
                error: function (e) {
                    console.log(e.message);
                }
            });
        }

        function deleteComment(commentId) {

            const p_trans = {};
            let cHtml = '';
            p_trans.commentId = commentId;

            $.ajax({
                dataType: 'json',
                type: "DELETE",
                contentType: "application/json;charset=utf-8",
                url: '/api/v1/comments',
                async: false,
                data: JSON.stringify(p_trans),
                success: function (data) {
                    alert("댓글이 수정되었습니다.");
                    selComments();
                },
                error: function (e) {
                    console.log(e.message);
                }
            });
        }
    </script>
</head>


<th:block layout:fragment="content">
    <div class="container p-5">
        <input type="hidden" th:value="${product.productId}" id="productId">
        <input type="hidden" th:value="${product.user.id}" id="authorId">
        <!-- image slider -->
        <div class="row justify-content-center">
            <div class="col-md-10">
                <div id="carouselExampleIndicators" class="carousel slide" data-ride="carousel">
                    <ol class="carousel-indicators">
                        <li data-target="#carouselExampleIndicators" data-slide-to="0" class="active"></li>
                        <li data-target="#carouselExampleIndicators" data-slide-to="1"></li>
                        <li data-target="#carouselExampleIndicators" data-slide-to="2"></li>
                    </ol>
                    <div class="carousel-inner" style="padding-bottom: 20px;">
                        <!-- 화면에 띄울 이미지에 active를 표시-->
                        <div class="carousel-item active">
                            <img class="d-block w-100" style="height: 400px" th:src="${product.getProductImage1}"
                                 alt="First slide">
                        </div>
                        <div class="carousel-item ">
                            <img class="d-block w-100" style="height: 400px" th:src="${product.getProductImage2}"
                                 alt="Second slide">
                        </div>
                        <div class="carousel-item">
                            <img class="d-block w-100" style="height: 400px" th:src="${product.getProductImage3}"
                                 alt="Third slide">
                        </div>
                    </div>
                    <a class="carousel-control-prev" role="button" data-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="sr-only">Previous</span>
                    </a>
                    <a class="carousel-control-next" role="button" data-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="sr-only">Next</span>
                    </a>
                </div>
            </div>
        </div>
        <!-- image slider-->

        <!-- title & tags & contents-->
        <div class="row justify-content-center">
            <div class="col-md-10">
                <div class="card">
                    <div class="rowcard-body">
                        <input type="text" class="form-control" id="productName" name="title"
                               th:value="${product.productName}">
                        <!-- tag icons -->

                        <div class="form-group mb-4" id="codes" style="padding-top: 20px;"
                             th:value="${product.productCategory}">
                        </div>
                        <!-- tag icons -->
                        <div class="form-group mb-4">
                            <label for="productContent">내용</label>
                            <textarea class="form-control" id="productContent" rows="15"
                                      th:text="${product.productContent}"></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- title & tags & contents-->

        <!-- 나눔 상태-->
        <div class="row justify-content-center m-4">
            <div class="col-md-10">
                <div class="row justify-content-center">
                    <!-- 나눔 받기 버튼 -->
                    <div class="col-md-2 d-none">
                        <button type="button" class="btn btn-primary">나눔받기</button>
                    </div>
                    <!-- 나눔 받기 버튼 -->
                    <!-- 글 수정 삭제 -->
                    <div class="row justify-content-center" id="productStatus">
                        <div class="col-md-2">
                            <span> 나눔 진행중 </span>
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-primary" onclick="javascript:updateProduct()">글 수정</button>
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-primary" onclick="javascript:deleteProduct()">글 삭제
                            </button>
                        </div>
                    </div>
                    <!-- 글 수정 삭제-->
                    <!-- 나눔 진행중 (비로그인)-->
                    <div class="row text-center d-none">
                        <span> 나눔 진행중</span>
                    </div>
                    <!-- 나눔 완료-->
                    <div class="row text-center d-none">
                        <span> 나눔 완료</span>
                    </div>
                </div>
            </div>
        </div>
        <!--나눔 상태-->

        <!-- 댓글 입력 창 -->
        <div class="row justify-content-center" id="commentInput">
            <div class="col-md-10">
                <div class="card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-2">
                                <img src="https://mdbootstrap.com/img/Photos/Avatars/img%20(32).jpg"
                                     class="rounded-circle img-fluid" alt="">
                            </div>
                            <div class="col-md-10">
                                <div class="row">
                                    <div class="col-md-10">
                                        <textarea class="form-control" rows="3" placeholder="댓글을 입력하세요."></textarea>
                                    </div>
                                    <div class="col-md-2">
                                        <button type="button" class="btn btn-primary">입력</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- 댓글 입력 창 -->
        <!-- 댓글 리스트 -->
        <div class="row justify-content-center">
            <div class="col-md-10" id="comments">
                <!-- 댓글 (작성자)-->
                <div class="card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-2">
                                <img src="https://mdbootstrap.com/img/Photos/Avatars/img%20(32).jpg"
                                     class="rounded-circle img-fluid" alt="">
                            </div>
                            <div class="col-md-10">
                                <div class="row">
                                    <div class="col-md-10">
                                        <textarea class="form-control" rows="3" placeholder="댓글을 입력하세요."></textarea>
                                    </div>
                                    <div class="col-md-2">
                                        <button type="button" class="btn btn-outline-secondary">수정</button>
                                        <button type="button" class="btn btn-danger">삭제</button>
                                        <span style="font-size: 12px;">2020-05-05</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- 댓글 -->
                <!-- 댓글 (글 작성자)-->
<!--                <div class="card">-->
<!--                    <div class="card-body">-->
<!--                        <div class="row">-->
<!--                            <div class="col-md-2">-->
<!--                                <img src="https://mdbootstrap.com/img/Photos/Avatars/img%20(32).jpg"-->
<!--                                     class="rounded-circle img-fluid" alt="">-->
<!--                            </div>-->
<!--                            <div class="col-md-10">-->
<!--                                <div class="row">-->
<!--                                    <div class="col-md-10 justify-content-center">-->
<!--                                        <p>댓글 내용</p>-->
<!--                                    </div>-->
<!--                                    <div class="col-md-2 justify-content-center">-->
<!--                                        <button type="button" class="btn btn-primary p-2">나눔하기</button>-->
<!--                                        <span style="font-size: 12px;">2020-05-05</span>-->
<!--                                    </div>-->
<!--                                </div>-->
<!--                            </div>-->
<!--                        </div>-->
<!--                    </div>-->
<!--                </div>-->
<!--                &lt;!&ndash; 댓글 &ndash;&gt;-->
<!--                &lt;!&ndash; 댓글 &ndash;&gt;-->
<!--                <div class="card">-->
<!--                    <div class="card-body">-->
<!--                        <div class="row">-->
<!--                            <div class="col-md-2">-->
<!--                                <img src="https://mdbootstrap.com/img/Photos/Avatars/img%20(32).jpg"-->
<!--                                     class="rounded-circle img-fluid" alt="">-->
<!--                            </div>-->
<!--                            <div class="col-md-10">-->
<!--                                <div class="row">-->
<!--                                    <div class="col-md-10 justify-content-center">-->
<!--                                        <p>댓글 내용</p>-->
<!--                                    </div>-->
<!--                                    <div class="col-md-2 justify-content-center">-->
<!--                                        <span style="font-size: 12px;">2020-05-05</span>-->
<!--                                    </div>-->
<!--                                </div>-->
<!--                            </div>-->
<!--                        </div>-->
<!--                    </div>-->
<!--                </div>-->
                <!-- 댓글 -->
            </div>
        </div>
    </div>
</th:block>
</html>