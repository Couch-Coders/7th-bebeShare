<!doctype html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout}">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">


    <th:block layout:fragment="css">
        <style th:inline="css">
            .center-img {
                height: 300px;
                width: 100%;
            }

            .card-text {
                height: 300px;
            }
        </style>
    </th:block>

    <title>배배쉐어</title>
    <script>

        let comments;

        $(function () {


            selCodes();
            selComments();
            productStatus();

            $("input:checkbox[name=category]").click(function () { //체크박스 동작 이벤트
                    $("input:checkbox[name=category]").prop('checked', false)
                    $("input:checkbox[name=category]").removeClass('checked')
                    $(this).prop('checked', true)
                    $(this).addClass('checked')
                }
            );


            //비로그인시 댓글 입력창 상품 수정 삭제를 안보야됨
            if (!localStorage.getItem("userId")) {
                $('#productStatus').hide()
                $('#commentInput').hide()
            }
            // 자기가등록한 상품이 아닐시 상품삭제  변경 버튼은 숨겨야된다
            if (localStorage.getItem("userId") !== $('#authorId').val()) {
                $('#updateProduct').hide();
                $('#deleteProdudct').hide();
                $('#productName').attr("readonly","readonly");
                $('#productContent').attr("readonly","readonly");
                $('.form-check-input').attr("disabled","disabled");
            }

            $('#commentImg').attr("src",localStorage.getItem("userPicture"));
        });

        function selCodes() {

            const p_trans = {};
            let cHtml = '';
            p_trans.code = "100";

            $.ajax({
                dataType: 'json',
                type: "POST",
                contentType: "application/json;charset=utf-8",
                url: '/api/v1/categories',
                async: false,
                data: JSON.stringify(p_trans),
                success: function (data) {
                    console.log("카테고리리스트:{}", data);
                    const categories = data;

                    for (var i = 0; i < categories.length; i++) {
                        cHtml += '<div class="form-check form-check-inline">';
                        cHtml += '<input class="form-check-input" type="checkbox" id="' + categories[i].code + '" name="category">';
                        cHtml += '<label class="form-check-label" htmlFor="form-tags">' + categories[i].codeName + '</label>';
                        cHtml += '</div>';

                    }

                    $('#codes').html(cHtml);
                },
                error: function (e) {
                    console.log(e.message);
                }
            });
            //현재 상품 카테고리 체크해주기
            $('#' + $('#codes').attr('value')).prop('checked', true);
            $('#' + $('#codes').attr('value')).addClass('checked');
        }


        function updateProduct() {

            const p_trans = {};
            let cHtml = '';
            p_trans.productId = $('#productId').val();
            p_trans.productName = $('#productName').val();
            p_trans.productContent = $('#productContent').val();
            p_trans.productCategory = $('.checked').attr('id');

            $.ajax({
                dataType: 'json',
                type: "PATCH",
                contentType: "application/json;charset=utf-8",
                url: '/api/v1/products',
                async: false,
                data: JSON.stringify(p_trans),
                success: function (data) {
                    alert("상품 수정이 성공 되었습니다.");
                    location.reload();
                },
                error: function (e) {
                    console.log(e.message);
                }
            });
        }

        function deleteProduct() {

            const p_trans = {};
            let cHtml = '';
            p_trans.productId = $('#productId').val();
            p_trans.deleteYn = "Y";

            $.ajax({
                dataType: 'json',
                type: "DELETE",
                contentType: "application/json;charset=utf-8",
                url: '/api/v1/products',
                async: false,
                data: JSON.stringify(p_trans),
                success: function (data) {
                    alert("상품이 삭제 되었습니다.");
                    window.location.href = '/';
                },
                error: function (e) {
                    console.log(e.message);
                }
            });
        }


        function selComments() {

            $('#comments').empty();


            const p_trans = {};
            p_trans.productId = $('#productId').val()
            let cHtml = '';
            // p_trans.code = "100";

            $.ajax({
                dataType: 'json',
                type: "POST",
                contentType: "application/json;charset=utf-8",
                url: '/api/v1/comments',
                async: false,
                data: JSON.stringify(p_trans),
                success: function (data) {
                    console.log("댓글리스트:{}", data);
                    comments = data.content;
                    //글쓴이랑 접속한 아이디랑 같으면
                    if (localStorage.getItem('userId') == $('#authorId').val()) {
                        $('#comments').html(authorRender(comments));
                    } else {
                        $('#comments').html(otherRender(comments, localStorage.getItem('userId')));
                    }


                },
                error: function (e) {
                    console.log(e.message);
                }
            });

        }


        function insertCommnet() {

            const p_trans = {};
            let cHtml = '';
            p_trans.productId = $('#productId').val();
            p_trans.memberId = localStorage.getItem("userId");
            p_trans.commentContent = $('#insertCommentContent').val();

            $.ajax({
                dataType: 'json',
                type: "POST",
                contentType: "application/json;charset=utf-8",
                url: '/api/v1/comments/'+$('#productId').val(),
                async: false,
                data: JSON.stringify(p_trans),
                success: function (data) {
                    alert("댓글이 등록되었습니다.");
                    selComments();
                },
                error: function (e) {
                    console.log(e.message);
                }
            });
        }

        function updateComment(index) {

            const p_trans = {};
            let cHtml = '';
            p_trans.commentId = comments[index].commentId;
            p_trans.commentContent = $('#content' + index).val();

            $.ajax({
                dataType: 'json',
                type: "PATCH",
                contentType: "application/json;charset=utf-8",
                url: '/api/v1/comments',
                async: false,
                data: JSON.stringify(p_trans),
                success: function (data) {
                    alert("댓글이 수정되었습니다.");
                    selComments();
                },
                error: function (e) {
                    console.log(e.message);
                }
            });
        }

        function deleteComment(commentId) {

            const p_trans = {};
            let cHtml = '';
            p_trans.commentId = commentId;

            $.ajax({
                dataType: 'json',
                type: "DELETE",
                contentType: "application/json;charset=utf-8",
                url: '/api/v1/comments',
                async: false,
                data: JSON.stringify(p_trans),
                success: function (data) {
                    alert("댓글이 삭제 되었습니다.");
                    selComments();
                },
                error: function (e) {
                    console.log(e.message);
                }
            });
        }

        function addComments() {
            const p_trans = {};
            let cHtml = '';
            p_trans.page = $('.col-md-10 .card-body').length - 1;
            p_trans.size = 5;
            p_trans.productId = $('#productId').val()

            $.ajax({
                dataType: 'json',
                type: "POST",
                contentType: "application/json;charset=utf-8",
                url: '/api/v1/comments',
                data: JSON.stringify(p_trans),
                success: function (data) {
                    console.log("댓글리스트:{}", data);
                    comments = data.content;
                    if (localStorage.getItem('userId') == $('#authorId').val()) {
                        $('#comments').append(authorRender(comments));
                    } else {
                        $('#comments').append(otherRender(comments, localStorage.getItem('userId')));
                    }
                },
                error: function (e) {
                    console.log(e.message);
                }
            });
        }


        function authorRender(comments) {

            let cHtml = '';

            for (var i = 0; i < comments.length; i++) {
                cHtml += '<div class="card">';
                cHtml += '<div class="card-body">';
                cHtml += '  <div class="row">';
                cHtml += '      <div class="col-md-2">';
                cHtml += '          <img src="' + comments[i].picture + '" class="rounded-circle img-fluid" alt="" style="width: 118.66px;height: 118.66px;">';
                cHtml += '      </div>';


                if($('#shareId').val() != ''){
                     cHtml += '              <div class="col-md-10">';
                     cHtml += '              <div class="row">';
                     cHtml += '              <div class="col-md-10 justify-content-center">';
                     cHtml += '                  <p>' + comments[i].commentContent + '</p>';
                     cHtml += '              </div>';
                     cHtml += '              <div class="col-md-2">';
                     cHtml += '                    <span style="font-size: 12px;">' + comments[i].insertDt + '</span>';
                     cHtml += '              </div>';
                 }


                else if (comments[i].userId == $('#authorId').val()) {
                    cHtml += '              <div class="col-md-10">';
                    cHtml += '                <div class="row">';
                    cHtml += '                    <div class="col-md-10">';
                    cHtml += '                        <textarea class="form-control" rows="3" id="' + 'content' + i + '">' + comments[i].commentContent + '</textarea>';
                    cHtml += '                    </div>';
                    cHtml += '                    <div class="col-md-2">';
                    cHtml += '                        <button type="button" class="btn btn-outline-secondary" onclick="javascript:updateComment(' + i + ')">수정</button>';
                    cHtml += '                        <button type="button" class="btn btn-danger" onclick="javascript:deleteComment(' + comments[i].commentId + ')">삭제</button>';
                    cHtml += '                        <span style="font-size: 12px;">' + comments[i].insertDt + '</span>';
                    cHtml += '                    </div>';
                } else {
                    cHtml += '              <div class="col-md-10">';
                    cHtml += '              <div class="row">';
                    cHtml += '              <div class="col-md-10 justify-content-center">';
                    cHtml += '                  <p>' + comments[i].commentContent + '</p>';
                    cHtml += '              </div>';
                    cHtml += '              <div class="col-md-2">';
                    cHtml += '                    <button type="button" class="btn btn-primary p-2" id="shareBtn" onclick="javascript:approveShare('+comments[i].userId+')">나눔하기</button>';
                    cHtml += '                    <span style="font-size: 12px;">' + comments[i].insertDt + '</span>';
                    cHtml += '              </div>';
                }
                cHtml += '              </div>';
                cHtml += '              </div>';
                cHtml += '              </div>';
                cHtml += '              </div>';
                cHtml += '              </div>';
            }

            return cHtml;
        }

        function otherRender(comments, otherId) {

            let cHtml = '';

            for (var i = 0; i < comments.length; i++) {
                cHtml += '<div class="card">';
                cHtml += '<div class="card-body">';
                cHtml += '  <div class="row">';
                cHtml += '      <div class="col-md-2">';
                cHtml += '          <img src="' + comments[i].picture + '" class="rounded-circle img-fluid" alt="" style="width: 118.66px;height: 118.66px;">';
                cHtml += '      </div>';


                if(comments[i].userId === comments[i].shareId){
                    cHtml += '              <div class="col-md-10">';
                    cHtml += '              <div class="row">';
                    cHtml += '              <div class="col-md-10 justify-content-center">';
                    cHtml += '                  <p>' + comments[i].commentContent + '</p>';
                    cHtml += '              </div>';
                    cHtml += '              <div class="col-md-2">';
                    cHtml += '                    <span style="font-size: 12px;">' + comments[i].insertDt + '</span>';
                    cHtml += '                        <button type="button" class="btn btn-outline-secondary" onclick="javascript:completeShare()">승인</button>';
                    cHtml += '                        <button type="button" class="btn btn-danger" onclick="javascript:rejectShare()">거부</button>';
                    cHtml += '              </div>';
                }


                else if (comments[i].userId == otherId) {
                    cHtml += '              <div class="col-md-10">';
                    cHtml += '                <div class="row">';
                    cHtml += '                    <div class="col-md-10">';
                    cHtml += '                        <textarea class="form-control" rows="3" id="' + 'content' + i + '">' + comments[i].commentContent + '</textarea>';
                    cHtml += '                    </div>';
                    cHtml += '                    <div class="col-md-2">';
                    cHtml += '                        <button type="button" class="btn btn-outline-secondary" onclick="javascript:updateComment(' + i + ')">수정</button>';
                    cHtml += '                        <button type="button" class="btn btn-danger" onclick="javascript:deleteComment(' + comments[i].commentId + ')">삭제</button>';
                    cHtml += '                        <span style="font-size: 12px;">' + comments[i].insertDt + '</span>';
                    cHtml += '                    </div>';
                } else {
                    cHtml += '              <div class="col-md-10">';
                    cHtml += '              <div class="row">';
                    cHtml += '              <div class="col-md-10 justify-content-center">';
                    cHtml += '                  <p>' + comments[i].commentContent + '</p>';
                    cHtml += '              </div>';
                    cHtml += '              <div class="col-md-2">';
                    cHtml += '                    <span style="font-size: 12px;">' + comments[i].insertDt + '</span>';
                    cHtml += '              </div>';
                }
                cHtml += '              </div>';
                cHtml += '              </div>';
                cHtml += '              </div>';
                cHtml += '              </div>';
                cHtml += '              </div>';
            }

            return cHtml;
        }



        function completeShare() {

            const p_trans = {};
            p_trans.productId =$('#productId').val();

            let cHtml = '';


            $.ajax({
                dataType: 'json',
                type: "PATCH",
                contentType: "application/json;charset=utf-8",
                url: '/api/v1/products/completeShare',
                async: false,
                data: JSON.stringify(p_trans),
                success: function (data) {
                    alert("나눔하기 완료");
                    location.reload();
                },
                error: function (e) {
                    console.log(e.message);
                }
            });
        }

        function rejectShare() {

            const p_trans = {};
            p_trans.productId =$('#productId').val();

            let cHtml = '';

            $.ajax({
                dataType: 'json',
                type: "PATCH",
                contentType: "application/json;charset=utf-8",
                url: '/api/v1/products/rejectShare',
                async: false,
                data: JSON.stringify(p_trans),
                success: function (data) {
                    alert("나눔하기 거절 완료");
                    location.reload();
                },
                error: function (e) {
                    console.log(e.message);
                }
            });
        }

        function approveShare(id) {

            const p_trans = {};
            let cHtml = '';
            p_trans.productId =$('#productId').val();
            p_trans.shareId =id;

            $.ajax({
                dataType: 'json',
                type: "PATCH",
                contentType: "application/json;charset=utf-8",
                url: '/api/v1/products/approveShare',
                async: false,
                data: JSON.stringify(p_trans),
                success: function (data) {
                    alert("나눔하기 완료");
                    location.reload();
                },
                error: function (e) {
                    console.log(e.message);
                }
            });
        }

        function productStatus(){
            if($('#productStatus').val() == 'N' || $('#productStatus').val() == 'I'){
                $('#sharingProduct').removeClass("d-none");
                $('#completeShare').addClass("d-none");
                return;
            }

            $('#completeShare').removeClass("d-none");
            $('#sharingProduct').addClass("d-none");
            $('#updateProduct').hide();
            $('#deleteProdudct').hide();
            $('.card-body button').hide();


            return;
        }
    </script>
</head>


<th:block layout:fragment="content">
    <div class="container p-5">
        <input type="hidden" th:value="${product.productId}" id="productId">
        <input type="hidden" th:value="${product.user.id}" id="authorId">
        <input type="hidden" th:value="${product.shareId}" id="shareId">
        <input type="hidden" th:value="${product.productStatus}" id="productStatus">
        <!-- image slider -->
        <div class="row justify-content-center">
            <div class="col-md-10">
                <div id="carouselExampleIndicators" class="carousel slide" data-ride="carousel">
                    <ol class="carousel-indicators">
                        <li data-target="#carouselExampleIndicators" data-slide-to="0" class="active"></li>
                        <li data-target="#carouselExampleIndicators" data-slide-to="1"></li>
                        <li data-target="#carouselExampleIndicators" data-slide-to="2"></li>
                    </ol>
                    <div class="carousel-inner" style="padding-bottom: 20px;">
                        <!-- 화면에 띄울 이미지에 active를 표시-->
                        <div class="carousel-item active">
                            <img class="d-block w-100" style="height: 400px" th:src="${product.getProductImage1}"
                                 alt="First slide">
                        </div>
                        <div class="carousel-item ">
                            <img class="d-block w-100" style="height: 400px" th:src="${product.getProductImage2}"
                                 alt="Second slide">
                        </div>
                        <div class="carousel-item">
                            <img class="d-block w-100" style="height: 400px" th:src="${product.getProductImage3}"
                                 alt="Third slide">
                        </div>
                    </div>
                    <a class="carousel-control-prev" role="button" data-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="sr-only">Previous</span>
                    </a>
                    <a class="carousel-control-next" role="button" data-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="sr-only">Next</span>
                    </a>
                </div>
            </div>
        </div>
        <!-- image slider-->

        <!-- title & tags & contents-->
        <div class="row justify-content-center">
            <div class="col-md-10">
                <div class="card">
                    <div class="rowcard-body">
                        <input type="text" class="form-control" id="productName" name="title"
                               th:value="${product.productName}">
                        <!-- tag icons -->

                        <div class="form-group mb-4" id="codes" style="padding-top: 20px;"
                             th:value="${product.productCategory}">
                        </div>
                        <!-- tag icons -->
                        <div class="form-group mb-4">
                            <label for="productContent">내용</label>
                            <textarea class="form-control" id="productContent" rows="15"
                                      th:text="${product.productContent}"></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- title & tags & contents-->

        <!-- 나눔 상태-->
        <div class="row justify-content-center m-4">
            <div class="col-md-10">
                <div class="row justify-content-center">
                    <!-- 나눔 받기 버튼 -->
                    <div class="col-md-2 d-none">
                        <button type="button" class="btn btn-primary">나눔받기</button>
                    </div>
                    <!-- 나눔 받기 버튼 -->
                    <!-- 글 수정 삭제 -->
                    <div class="row justify-content-center" >
                        <div class="col-md-2" id="sharingProduct">
                            <span> 나눔 진행중 </span>
                        </div>
                        <div class="row text-center d-none" id="completeShare">
                            <span> 나눔 완료</span>
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-primary" id="updateProduct" onclick="javascript:updateProduct()">글 수정
                            </button>
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-primary" id="deleteProdudct"  onclick="javascript:deleteProduct()">글 삭제
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!--나눔 상태-->

        <!-- 댓글 입력 창 -->
        <div class="row justify-content-center" id="commentInput">
            <div class="col-md-10">
                <div class="card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-2">
                                <img id="commentImg" src="https://mdbootstrap.com/img/Photos/Avatars/img%20(32).jpg"
                                     class="rounded-circle img-fluid" alt="">
                            </div>
                            <div class="col-md-10">
                                <div class="row">
                                    <div class="col-md-10">
                                        <textarea class="form-control" rows="3" placeholder="댓글을 입력하세요." id="insertCommentContent"></textarea>
                                    </div>
                                    <div class="col-md-2">
                                        <button type="button" class="btn btn-primary" onclick="insertCommnet()">입력</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- 댓글 입력 창 -->
        <!-- 댓글 리스트 -->
        <div class="row justify-content-center">
            <div class="col-md-10" id="comments">

            </div>
        </div>
    </div>

    <div class="row d-flex justify-content-center">
        <button type="button" class="btn btn-link" onclick="addComments()">더보기</button>
    </div>
</th:block>
</html>